rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read all user docs and write their own
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.email == userId;
    }

    // Core data collections - all authenticated users can read, controlled writes
    match /individuals/{document} {
      allow read: if request.auth != null;
      // Allow writes for authenticated users - app logic will control admin permissions
      allow write: if request.auth != null;
    }

    match /houses/{document} {
      allow read: if request.auth != null;
      // Allow writes for authenticated users - app logic will control admin permissions
      allow write: if request.auth != null;
    }

    match /pointCategories/{document} {
      allow read: if request.auth != null;
      // Allow writes for authenticated users - app logic will control admin permissions
      allow write: if request.auth != null;
    }

    // Admin-only collections (restrict at database level)
    match /futureHouseRoster/{document} {
      allow read: if request.auth != null;
      // Only allow writes if user email is in a hardcoded admin list (avoid circular dependency)
      allow write: if request.auth != null &&
                     request.auth.token.email in ['bschott@cgps.org', 'admin@cgps.org'];
    }

    // Bonus points subcollections
    match /houses/{houseId}/bonusPoints/{bonusPointId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Point events collection for audit trail and rollback functionality
    match /pointsEvents/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Rollback requests collection for batch rollback functionality
    match /rollbackRequests/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Aggregated data collections (if they exist)
    match /houseSummaries/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /houseRankings/{houseId}/students/{studentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Fallback for any other collections - read only
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Deny writes to unknown collections
    }
  }
}